{% extends "paciente/paciente_layout.html" %}
{% load widget_tweaks %}
{% block title %}Reservar Turno {% endblock title %}
{% block import_links %}
    {# Adds all flatpickr JS/CSS files from CDN #}
    {{ especialidad_form.media.css }} 
    <link href="https://unpkg.com/flatpickr@4.6.3/dist/themes/light.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.20/af-2.3.4/b-1.6.1/b-colvis-1.6.1/b-flash-1.6.1/b-html5-1.6.1/cr-1.5.2/fc-3.3.0/fh-3.1.6/kt-2.5.1/r-2.2.3/rg-1.1.1/rr-1.2.6/sc-2.0.1/sl-1.3.1/datatables.css"/>
{% endblock %}
{% block css %}
    .form-card {
        background-color: #06b2b6;
        color: #fffefe;
    }
    .reserva-radio-button input[type=radio] {
        transform:scale(1.4);
    }
{% endblock %}
{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="p-0 form-container container mt-5 shadow mb-4 bg-white rounded">
                <div class="form-header pl-5 py-3">
                    <h2>{{ accion }} Turno</h2>
                </div>
                <div class="py-3 px-5">
                    <form id="form-buscar-turnos" method="GET" data-url='/paciente/ajax/buscar-turnos'>
                        <div class="form-row">
                            <div class="col-7">
                                <label for="{{ especialidad_form.especialidad.id_for_label }}">Especialidad</label>
                                {{ especialidad_form.especialidad|add_class:"form-control" }}
                            </div>
                            <div class="col-5">
                                <label for="{{ especialidad_form.fecha.id_for_label }}">Fecha</label>
                                {% render_field especialidad_form.fecha id="form-datepicker" %}
                            </div>
                        </div>
                        <div class="form-group pt-1">
                                <label for="{{ medico_form.medico.id_for_label }}">Medico</label>
                                {{ medico_form.medico|add_class:"form-control" }}
                        </div>
                        <div class="form-row justify-content-center">
                            <button type="submit" class="btn btn-primary py-2 px-5"><strong>BUSCAR</strong></button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="containerTurnos" class="px-5 py-4 form-container container shadow mb-5 bg-white rounded" hidden>
            </div>
        </div>
    </div>
{% endblock %}
{% block javascript %}
    {{ especialidad_form.media.js }}
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.20/af-2.3.4/b-1.6.1/b-colvis-1.6.1/b-flash-1.6.1/b-html5-1.6.1/cr-1.5.2/fc-3.3.0/fh-3.1.6/kt-2.5.1/r-2.2.3/rg-1.1.1/rr-1.2.6/sc-2.0.1/sl-1.3.1/datatables.js"></script>
    <!-- AJAX CALLS CODE -->
<script>
    $(document).ready(function(e){
        $(".flatpickr-input").prop("disabled",true);
        $("#id_medico").prop("disabled",true);
        $(".btn-paciente[type=submit]").prop("disabled",true);
    });
    // el formulario de input se va a habilitar una vez que se seleccione una especialidad vÃ¡lida
    $("#id_especialidad").on("change",function(event){
        if ($(this).val() > 0) {
            $(".flatpickr-input").prop("disabled",false);
        } else {
            $(".flatpickr-input").prop("disabled",true);
        }
    });
    // cuando cambia, seleccionando una fecha, se realiza un llamado AJAX
    $("#form-datepicker").on("change",function(event){
        let especialidadForm = $("#form-buscar-turnos");
        let $thisURL = "/paciente/ajax/filtrar-medicos";
        console.log($thisURL);
        let $formData = especialidadForm.serialize();
        console.log($thisURL);
        console.log($formData);
        $.ajax({
            method: "GET",
            url: $thisURL,
            data: $formData,
            success: function(data) {
                console.log(data);
                $("#id_medico").find("option").remove();
                $("#id_medico").append($('<option>').text("Seleccione un medico").prop("selected",true));
                $("#id_medico").prop("disabled",false);
                for (item in data) {
                    $('#id_medico').append($('<option>').val(data[item]['id']).text(data[item]['nombre']));
                }
            },
            error: function(data){
                console.log("error");
                console.log(data);
            },
        });
    });
    $("#id_medico").on("change",function(event) {
        if ($(this).val() > 0) {
            $(".btn-paciente[type=submit]").prop("disabled",false);
        } else {
            $(".btn-paciente[type=submit]").prop("disabled",true);
        }
    });
    $("#form-buscar-turnos").on("submit",function(event){
        event.preventDefault();
        /* $.(this) references the object which is "listening" to a event, in this case, it will be the form */
        let $thisURL = $(this).attr('data-url');
        let $formData = $(this).serialize();
        $.ajax({
            method: "GET",
            url: $thisURL,
            data: $formData,
            success: function(data) {
                let $containerTurnos = $("#containerTurnos");
                $containerTurnos.empty();
                $containerTurnos.html(data);
                $("#tabla-turnos").DataTable({
                    searching:false,
                    lengthChange:false,
                    ordering:false,
                });
                $containerTurnos.prop("hidden",false);
            },
            error: function(data){
                console.log("error");
                console.log(data);
            },
        });
    });
</script>
{% endblock %}
